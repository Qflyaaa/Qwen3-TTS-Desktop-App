# 生成参数保存功能说明

## 功能概述

已实现完整的生成参数保存机制，支持：
- ✅ 自动保存生成参数
- ✅ 查看参数详情
- ✅ 根据参数重新生成
- ✅ 批量复刻功能

## 功能详情

### 1. 自动保存参数

**功能说明：**
- 每次生成音频时，自动在同目录下创建对应的 JSON 参数文件
- 参数文件包含所有影响生成结果的参数

**文件命名规则：**
- 音频文件：`{voice_name}_{text_name}_{timestamp}.wav`
- 参数文件：`{voice_name}_{text_name}_{timestamp}.json`

**保存的参数包括：**
- 生成类型（voice_clone / voice_design）
- 文本内容
- 语气指令/音色描述
- 音色特征文件路径
- 语言设置
- 模型配置
- 生成时间
- 应用版本

### 2. 查看参数

**位置：** 文件管理 → 生成历史 → 查看参数

**功能：**
- 显示完整的生成参数信息
- 支持查看 JSON 原始数据
- 参数分类显示（基本信息、文本内容、模型配置等）

**使用步骤：**
1. 在生成历史中选择音频文件
2. 点击"查看参数"按钮
3. 查看参数详情窗口

### 3. 根据参数重新生成

**位置：** 文件管理 → 生成历史 → 重新生成

**功能：**
- 自动加载参数文件
- 填充所有生成字段
- 支持修改参数后生成
- 一键重新生成相同音频

**使用步骤：**
1. 在生成历史中选择音频文件
2. 点击"重新生成"按钮
3. 在对话框中可以修改文本或语气
4. 点击"重新生成"按钮

### 4. 批量复刻

**位置：** 文件管理 → 生成历史 → 批量复刻

**功能：**
- 选择多个参数文件
- 批量重新生成
- 支持批量修改文本内容
- 显示批量生成进度

**使用步骤：**
1. 点击"批量复刻"按钮
2. 添加参数文件（支持单个文件或整个文件夹）
3. （可选）勾选"批量修改文本"，输入新文本
4. 点击"开始批量生成"

## 参数文件格式

### 语音克隆参数文件示例

```json
{
  "generation_type": "voice_clone",
  "timestamp": "2026-02-02 14:30:00",
  "output_audio": "laoqiu_love_20260202_143000.wav",
  "output_audio_path": "data/outputs/laoqiu_love_20260202_143000.wav",
  "voice_clone": {
    "voice_features_path": "voice_features/laoqiu.pt",
    "voice_name": "laoqiu",
    "text": "文本内容...",
    "instruct": "语气指令（可选）",
    "language": "Chinese",
    "text_file_name": "love.txt"
  },
  "model": {
    "model_type": "Base",
    "model_path": "Qwen3-TTS-12Hz-1.7B-Base",
    "device": "cuda:0",
    "use_flash_attention": true
  },
  "app_version": "1.0.0"
}
```

### 音色设计参数文件示例

```json
{
  "generation_type": "voice_design",
  "timestamp": "2026-02-02 14:45:00",
  "output_audio": "test09_voice_design_20260202_144500.wav",
  "output_audio_path": "data/outputs/test09_voice_design_20260202_144500.wav",
  "voice_design": {
    "text": "文本内容...",
    "instruct": "音色描述...",
    "language": "Chinese",
    "text_file_name": "test09.txt"
  },
  "model": {
    "model_type": "VoiceDesign",
    "model_path": "Qwen3-TTS-12Hz-1.7B-VoiceDesign",
    "device": "cuda:0",
    "use_flash_attention": true
  },
  "app_version": "1.0.0"
}
```

## 使用场景

### 场景1：复刻生成
```
1. 找到之前生成的音频
2. 点击"重新生成"
3. 直接生成相同效果的音频
```

### 场景2：参数微调
```
1. 查看参数
2. 修改语气描述："深情温柔" → "欢快活泼"
3. 重新生成 → 得到不同风格的音频
```

### 场景3：批量处理
```
1. 选择多个参数文件
2. 批量修改文本内容
3. 批量生成 → 使用相同音色和语气生成不同文本
```

### 场景4：参数管理
```
1. 查看参数文件了解生成配置
2. 导出参数作为模板
3. 分享参数文件给他人使用
```

## 技术实现

### 核心模块

1. **`utils/generation_params.py`**
   - 参数保存和加载
   - 参数验证
   - 参数文件管理

2. **`core/params_regenerator.py`**
   - 根据参数重新生成
   - 批量重新生成
   - 参数修改支持

3. **`ui/dialogs/params_viewer.py`**
   - 参数查看对话框
   - 详细信息显示
   - JSON 数据查看

4. **`ui/dialogs/regenerate_dialog.py`**
   - 单个重新生成对话框
   - 参数修改界面

5. **`ui/dialogs/batch_regenerate_dialog.py`**
   - 批量重新生成对话框
   - 批量文件管理
   - 批量文本修改

### 集成点

- **`core/voice_generator.py`**: 生成时自动保存参数
- **`core/voice_designer.py`**: 生成时自动保存参数
- **`ui/tabs/manage_tab.py`**: 添加查看和重新生成按钮
- **`ui/main_window.py`**: 初始化参数重新生成器

## 注意事项

1. **参数文件关联**：参数文件与音频文件同名，仅扩展名不同
2. **删除音频**：删除音频时会提示是否同时删除参数文件
3. **参数验证**：重新生成前会自动验证参数完整性
4. **批量处理**：批量生成时，失败的项会返回 None，不影响其他项

## 未来扩展

- [ ] 参数文件导出/导入功能
- [ ] 参数模板管理
- [ ] 参数对比功能
- [ ] 参数历史版本管理
